<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Export MP4 (ffmpeg.wasm single-thread) — Bande 8%</title>
<style>
  body { font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial; margin:0; background:#f2f2f5; }
  .wrap { max-width:980px; margin:18px auto; padding:12px; }
  header { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
  .grid { display:flex; flex-direction:column; gap:18px; }
  .media-card { background:white; border-radius:12px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
  .media-inner { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
  .media-inner > * { width:48%; max-width:48%; border-radius:8px; overflow:hidden; background:#000; }
  img, video, canvas { display:block; width:100%; height:auto; }
  .meta { margin-top:10px; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap; }
  button { background:#007aff; color:white; border:0; padding:8px 10px; border-radius:8px; cursor:pointer; }
  button:disabled { background:#999; cursor:default; }
  .status { font-size:0.9rem; color:#333; }
  .progress { width:100%; background:#eee; height:8px; border-radius:6px; overflow:hidden; margin-top:8px; }
  .progress > i { display:block; height:100%; width:0%; background:#007aff; transition:width .2s linear; }
  .small { font-size:0.85rem; color:#555; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <input id="fileInput" type="file" accept="image/*,video/*" multiple>
    <button id="clearBtn">Effacer</button>
    <div id="globalStatus" class="status" style="margin-left:auto"></div>
  </header>
  <section id="preview" class="grid"></section>
</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
<script>
(async ()=> {
  const { createFFmpeg, fetchFile } = FFmpeg;
  const coreJsUrl = 'https://unpkg.com/@ffmpeg/core@0.11.6/dist/ffmpeg-core.js';
  const ffmpeg = createFFmpeg({ corePath: coreJsUrl, log: false });
  let ffmpegLoaded = false;

  const input = document.getElementById('fileInput');
  const preview = document.getElementById('preview');
  const clearBtn = document.getElementById('clearBtn');
  const globalStatus = document.getElementById('globalStatus');

  function setGlobalStatus(txt){ globalStatus.textContent = txt || ''; }
  function humanFileSize(bytes){
    const thresh = 1024;
    if(bytes < thresh) return bytes + ' B';
    const units = ['KB','MB','GB']; let u=-1;
    do { bytes /= thresh; ++u; } while(bytes >= thresh && u < units.length-1);
    return bytes.toFixed(1)+' '+units[u];
  }
  function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function createCard(file, idx){
    const url = URL.createObjectURL(file);
    const isVideo = file.type.startsWith('video/');
    const card = document.createElement('article'); card.className = 'media-card';
    const inner = document.createElement('div'); inner.className = 'media-inner';

    let orig;
    if(isVideo){
      orig = document.createElement('video');
      orig.src = url;
      orig.controls = true;
      orig.playsInline = true;
      orig.muted = true;
      orig.autoplay = true;
      orig.loop = true;
    } else {
      orig = document.createElement('img');
      orig.src = url;
      orig.alt = file.name;
    }
    inner.appendChild(orig);

    const canvas = document.createElement('canvas');
    inner.appendChild(canvas);
    card.appendChild(inner);

    const meta = document.createElement('div'); meta.className = 'meta';
    const left = document.createElement('div');
    left.innerHTML = `<div><strong>${escapeHtml(file.name)}</strong></div>
                      <div class="small">${file.type} • ${humanFileSize(file.size)}</div>`;
    const actions = document.createElement('div');

    const dlOrig = document.createElement('button');
    dlOrig.textContent = 'Télécharger original';
    dlOrig.onclick = ()=> { const a=document.createElement('a'); a.href=url; a.download=file.name; a.click(); };
    actions.appendChild(dlOrig);

    const dlWithBand = document.createElement('button');
    dlWithBand.textContent = isVideo ? 'Télécharger MP4 (avec bande)' : 'Télécharger image (avec bande)';
    dlWithBand.disabled = true;
    actions.appendChild(dlWithBand);

    meta.appendChild(left); meta.appendChild(actions); card.appendChild(meta);

    const progBox = document.createElement('div');
    progBox.style.marginTop = '8px';
    progBox.innerHTML = `<div class="status small"></div><div class="progress"><i></i></div>`;
    card.appendChild(progBox);
    const statusLine = progBox.querySelector('.status');
    const progBar = progBox.querySelector('.progress > i');

    if(!isVideo){
      const img = new Image();
      img.src = url;
      img.onload = () => {
        const band = Math.max(1, Math.round(img.height * 0.08));
        canvas.width = img.width; canvas.height = img.height + band;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        ctx.fillStyle = 'white';
        ctx.fillRect(0, img.height, img.width, band);
        dlWithBand.disabled = false;
        dlWithBand.onclick = () => {
          canvas.toBlob(blob => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = file.name.replace(/\.[^.]+$/, '') + '_bande.png';
            a.click();
          }, 'image/png', 1.0);
        };
      };
    } else {
      const player = document.createElement('video');
      player.src = url;
      player.muted = true; player.playsInline = true;
      player.style.display = 'none';
      document.body.appendChild(player);

      player.addEventListener('loadedmetadata', () => {
        const vw = player.videoWidth, vh = player.videoHeight;
        const band = Math.max(1, Math.floor(vh * 0.08));
        canvas.width = vw; canvas.height = vh + band;
        const ctx = canvas.getContext('2d');

        let raf;
        function liveDraw(){
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.drawImage(player, 0, 0, vw, vh);
          ctx.fillStyle = 'white';
          ctx.fillRect(0, vh, vw, band);
          raf = requestAnimationFrame(liveDraw);
        }
        player.play().catch(()=>{}); liveDraw();

        dlWithBand.disabled = false;
        dlWithBand.onclick = async () => {
          dlWithBand.disabled = true;
          statusLine.textContent = 'Préparation export...';
          setGlobalStatus('Export en cours...');
          progBar.style.width = '2%';

          try {
            if(!ffmpegLoaded){
              statusLine.textContent = 'Chargement ffmpeg.wasm...';
              progBar.style.width = '3%';
              await ffmpeg.load();
              ffmpegLoaded = true;
            }

            const inputName = `input_${idx}.mp4`;
            ffmpeg.FS('writeFile', inputName, await fetchFile(file));

            const outputName = `output_${idx}.mp4`;
            const bandHeight = Math.round(vh * 0.08);

            await ffmpeg.run(
              '-i', inputName,
              '-vf', `scale='min(1280,iw)':-2,drawbox=y=ih-${bandHeight}:color=white:width=iw:height=${bandHeight}:t=fill`,
              '-c:a', 'copy',
              '-movflags', 'faststart',
              outputName
            );

            const data = ffmpeg.FS('readFile', outputName);
            const mp4Blob = new Blob([data.buffer], { type: 'video/mp4' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(mp4Blob);
            a.download = file.name.replace(/\.[^.]+$/, '') + '_bande.mp4';
            a.click();

            statusLine.textContent = 'Export terminé.';
            progBar.style.width = '100%';
            setGlobalStatus('');
          } catch(err){
            console.error(err);
            alert('Erreur pendant l\'export : ' + (err?.message || err));
            statusLine.textContent = 'Erreur pendant l\'export.';
            setGlobalStatus('');
          } finally {
            dlWithBand.disabled = false;
          }
        };
      });
    }
    return card;
  }

  let fileIndex = 0;
  input.onchange = e => {
    Array.from(e.target.files).forEach(f => preview.appendChild(createCard(f, fileIndex++)));
    input.value = '';
  };
  clearBtn.onclick = () => { preview.innerHTML = ''; setGlobalStatus(''); };

})();
</script>
</body>
</html>